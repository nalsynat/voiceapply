<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>VoiceApply KH ğŸ™</title>
<link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&family=Hanuman:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --red: #1DA1F2;
    --red-dark: #1A91DA;
    --red-light: #4AB3F4;
    --gold: #FFB703;
    --dark: #0D0D0D;
    --dark2: #1A1A1A;
    --dark3: #242424;
    --card: #1E1E1E;
    --border: #2E2E2E;
    --text: #F5F5F5;
    --text-muted: #888;
    --green: #06D6A0;
    --radius: 16px;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body {
    background:var(--dark); color:var(--text);
    font-family:'Kantumruy Pro','Hanuman',sans-serif;
    min-height:100vh; overflow-x:hidden;
    max-width:420px; margin:0 auto;
  }
  .screen { display:none; min-height:100vh; flex-direction:column; animation:fadeUp .35s ease forwards; }
  .screen.active { display:flex; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
  .header {
    padding:16px 20px 14px; background:var(--dark);
    position:sticky; top:0; z-index:10;
    border-bottom:1px solid var(--border);
  }
  .header-top { display:flex; align-items:center; justify-content:space-between; }
  .logo { display:flex; align-items:center; gap:10px; }
  .logo-icon { width:36px;height:36px;background:var(--red);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px; }
  .logo-text { font-size:18px; font-weight:700; }
  .logo-text span { color:var(--red); }
  .badge { background:var(--gold);color:var(--dark);font-size:11px;font-weight:700;padding:3px 8px;border-radius:20px; }
  .header-sub { margin-top:6px; font-size:13px; color:var(--text-muted); }
  .back-btn { background:none;border:none;color:var(--text-muted);font-size:14px;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:6px;padding:0; }
  .loading-wrap { display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:16px; }
  .spinner { width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--red);border-radius:50%;animation:spin .8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-size:14px;color:var(--text-muted); }
  .jobs-container { padding:16px;display:flex;flex-direction:column;gap:14px;flex:1; }
  .section-title { font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;padding:0 4px;margin-bottom:2px; }
  .job-card { background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid var(--border);cursor:pointer;transition:all .2s;position:relative;overflow:hidden; }
  .job-card::before { content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--red);border-radius:4px 0 0 4px; }
  .job-card:active { transform:scale(.98);border-color:var(--red); }
  .job-header { display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px; }
  .job-emoji { width:44px;height:44px;background:var(--dark3);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0; }
  .job-urgency { background:rgba(230,57,70,.15);color:var(--red-light);font-size:11px;font-weight:600;padding:4px 8px;border-radius:20px;border:1px solid rgba(230,57,70,.3); }
  .job-title { font-size:17px;font-weight:700;margin:10px 0 4px;line-height:1.3; }
  .job-company { font-size:14px;color:var(--text-muted);margin-bottom:12px; }
  .job-tags { display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px; }
  .tag { background:var(--dark3);color:var(--text-muted);font-size:12px;padding:4px 10px;border-radius:20px;border:1px solid var(--border); }
  .tag.highlight { background:rgba(255,183,3,.1);color:var(--gold);border-color:rgba(255,183,3,.3); }
  .apply-btn { width:100%;background:var(--red);color:white;border:none;border-radius:12px;padding:13px;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px; }
  .apply-btn:active { background:var(--red-dark);transform:scale(.98); }
  .form-container { padding:20px;flex:1;display:flex;flex-direction:column;gap:20px; }
  .form-hero { background:linear-gradient(135deg,var(--red) 0%,var(--red-dark) 100%);border-radius:var(--radius);padding:20px;text-align:center; }
  .form-hero-icon { font-size:36px;margin-bottom:8px; }
  .form-hero-title { font-size:18px;font-weight:700;margin-bottom:4px; }
  .form-hero-sub { font-size:13px;opacity:.85; }
  .form-group { display:flex;flex-direction:column;gap:8px; }
  .form-label { font-size:14px;font-weight:600;color:var(--text-muted); }
  .form-input { background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;font-size:16px;font-family:inherit;color:var(--text);outline:none;transition:border-color .2s; }
  .form-input:focus { border-color:var(--red); }
  .form-input::placeholder { color:var(--text-muted); }
  .form-select { background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;font-size:16px;font-family:inherit;color:var(--text);outline:none;transition:border-color .2s;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23888' d='M6 8L0 0h12z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center; }
  .form-select:focus { border-color:var(--red); }
  .form-select option { background:var(--dark2); }
  .next-btn { background:var(--red);color:white;border:none;border-radius:12px;padding:15px;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;margin-top:auto; }
  .next-btn:active { background:var(--red-dark);transform:scale(.98); }
  .voice-container { padding:20px;flex:1;display:flex;flex-direction:column;align-items:center;gap:18px; }
  .voice-job-card { width:100%;background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid var(--border);display:flex;align-items:center;gap:12px; }
  .voice-job-icon { width:42px;height:42px;background:var(--dark3);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0; }
  .voice-job-info { flex:1; }
  .voice-job-title { font-size:15px;font-weight:700; }
  .voice-job-company { font-size:13px;color:var(--text-muted); }
  .prompt-box { width:100%;background:rgba(255,183,3,.08);border:1px solid rgba(255,183,3,.25);border-radius:var(--radius);padding:16px; }
  .prompt-title { font-size:12px;color:var(--gold);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px; }
  .prompt-text { font-size:15px;line-height:1.6; }
  .prompt-hints { margin-top:10px;display:flex;flex-direction:column;gap:4px; }
  .prompt-hint { font-size:13px;color:var(--text-muted);display:flex;align-items:center;gap:6px; }
  .prompt-hint::before { content:'â€¢';color:var(--gold); }
  .record-area { display:flex;flex-direction:column;align-items:center;gap:14px;width:100%; }
  .timer-ring { position:relative;width:160px;height:160px;flex-shrink:0; }
  .timer-ring svg { width:160px;height:160px;transform:rotate(-90deg);position:absolute;top:0;left:0;z-index:1; }
  .timer-track { fill:none;stroke:var(--border);stroke-width:6; }
  .timer-progress { fill:none;stroke:var(--red);stroke-width:6;stroke-linecap:round;stroke-dasharray:408;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear,stroke .3s; }
  .timer-center { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;z-index:3;pointer-events:none; }
  .timer-seconds { font-size:30px;font-weight:700;line-height:1;color:var(--text);text-shadow:0 1px 4px rgba(0,0,0,.8); }
  .timer-label { font-size:11px;color:var(--text-muted); }
  .record-btn { width:88px;height:88px;border-radius:50%;background:var(--red);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:32px;transition:all .2s;position:absolute;inset:0;margin:auto;z-index:2; }
  .record-btn.recording { animation:pulse 1.5s infinite;background:var(--red-dark); }
  @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(230,57,70,.5)} 70%{box-shadow:0 0 0 20px rgba(230,57,70,0)} 100%{box-shadow:0 0 0 0 rgba(230,57,70,0)} }
  .record-btn:active { transform:scale(.93); }
  .record-status { font-size:14px;color:var(--text-muted);text-align:center;min-height:20px; }
  .record-status.recording { color:var(--red-light);font-weight:600; }
  .record-status.done { color:var(--green);font-weight:600; }
  .waveform { display:flex;align-items:center;justify-content:center;gap:3px;height:40px;width:100%;opacity:0;transition:opacity .3s; }
  .waveform.active { opacity:1; }
  .wave-bar { width:3px;background:var(--red);border-radius:3px;animation:wave .8s ease-in-out infinite;min-height:4px; }
  @keyframes wave { 0%,100%{height:6px} 50%{height:28px} }
  .playback-section { width:100%;background:var(--card);border-radius:var(--radius);padding:14px 16px;border:1px solid var(--border);display:none;align-items:center;gap:12px; }
  .playback-section.visible { display:flex; }
  .play-btn { width:40px;height:40px;background:var(--green);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;transition:transform .2s; }
  .play-btn:active { transform:scale(.92); }
  .playback-info { flex:1; }
  .playback-title { font-size:14px;font-weight:600;color:var(--green); }
  .playback-sub { font-size:12px;color:var(--text-muted); }
  .rerecord-btn { background:none;border:1px solid var(--border);color:var(--text-muted);font-size:12px;font-family:inherit;padding:6px 10px;border-radius:8px;cursor:pointer; }
  .submit-btn { width:100%;background:linear-gradient(135deg,var(--red) 0%,var(--red-dark) 100%);color:white;border:none;border-radius:12px;padding:16px;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;display:none;align-items:center;justify-content:center;gap:8px;margin-top:auto;box-shadow:0 4px 20px rgba(230,57,70,.3); }
  .submit-btn.visible { display:flex; }
  .submit-btn:active { transform:scale(.98); }
  .submit-btn.loading { opacity:.7;cursor:not-allowed; }
  .success-container { padding:20px;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;text-align:center; }
  .success-anim { width:100px;height:100px;background:rgba(6,214,160,.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) forwards;border:2px solid rgba(6,214,160,.3); }
  @keyframes popIn { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }
  .success-title { font-size:24px;font-weight:700;line-height:1.3; }
  .success-title span { color:var(--green); }
  .success-sub { font-size:15px;color:var(--text-muted);line-height:1.7;max-width:300px; }
  .success-details { width:100%;background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid var(--border);text-align:left;display:flex;flex-direction:column;gap:12px; }
  .success-row { display:flex;align-items:center;gap:12px; }
  .success-row-icon { width:32px;height:32px;background:var(--dark3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0; }
  .success-row-text { font-size:14px;color:var(--text-muted); }
  .success-row-text strong { color:var(--text);display:block; }
  .home-btn { width:100%;background:var(--card);color:var(--text);border:1.5px solid var(--border);border-radius:12px;padding:14px;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s;margin-top:8px; }
  .home-btn:active { border-color:var(--red);color:var(--red); }
  .error-wrap { display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:16px;padding:20px;text-align:center; }
  .error-icon { font-size:48px; }
  .error-title { font-size:18px;font-weight:700;color:var(--red); }
  .error-sub { font-size:14px;color:var(--text-muted);line-height:1.6; }
  .retry-btn { background:var(--red);color:white;border:none;border-radius:12px;padding:12px 24px;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer; }
  .toast { position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--dark3);border:1px solid var(--border);color:var(--text);padding:12px 20px;border-radius:12px;font-size:14px;font-weight:500;z-index:999;transition:transform .3s ease;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.4); }
  .toast.show { transform:translateX(-50%) translateY(0); }
  .toast.error { border-color:var(--red);color:var(--red-light); }
  .toast.success { border-color:var(--green);color:var(--green); }
  ::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<div class="screen active" id="screen-jobs">
  <div class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">ğŸ™</div>
        <div class="logo-text">Voice<span>Apply</span></div>
      </div>
      <div class="badge">ğŸ‡°ğŸ‡­ á€á˜áŸ’á–á»á‡á¶</div>
    </div>
    <div class="header-sub">ášá€á€á¶ášá„á¶áš Â· áŠá¶á€áŸ‹á–á¶á€áŸ’á™á€áŸ’á“á»á„ áŸ¦áŸ  áœá·á“á¶á‘á¸</div>
  </div>
  <div class="jobs-container" id="jobs-list">
    <div class="loading-wrap">
      <div class="spinner"></div>
      <div class="loading-text">á€áŸ†á–á»á„á‘á¶á‰á€á¶ášá„á¶áš...</div>
    </div>
  </div>
</div>

<div class="screen" id="screen-profile">
  <div class="header">
    <div class="header-top">
      <button class="back-btn" onclick="goBack('screen-jobs')">â† ááŸ’ášá¡á”áŸ‹</button>
    </div>
  </div>
  <div class="form-container">
    <div class="form-hero">
      <div class="form-hero-icon">ğŸ‘¤</div>
      <div class="form-hero-title">á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“ááŸ’á›á¸</div>
      <div class="form-hero-sub">ááŸ‚ áŸ¡ áŠá„ Â· ášá€áŸ’áŸá¶á‘á»á€áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·</div>
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ“› áˆáŸ’á˜áŸ„áŸ‡á–áŸá‰</label>
      <input class="form-input" type="text" id="input-name" placeholder="á§. áŸá»áá¶ á…á¶á“áŸ‹"/>
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ“± á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘</label>
      <input class="form-input" type="tel" id="input-phone" placeholder="á§. 012 345 678"/>
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ’¼ á˜á»áá„á¶ášáŠáŸ‚á›á…á„áŸ‹á”á¶á“</label>
      <select class="form-select" id="input-position">
        <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸ --</option>
        <option value="á¢áŸ’á“á€á”á˜áŸ’ášá¾áá»">ğŸ½ï¸ á¢áŸ’á“á€á”á˜áŸ’ášá¾áá» (Waiter)</option>
        <option value="á¢áŸ’á“á€á…á˜áŸ’á¢á·á“á˜áŸ’á á¼á”">ğŸ‘¨â€ğŸ³ á¢áŸ’á“á€á…á˜áŸ’á¢á·á“á˜áŸ’á á¼á” (Cook)</option>
        <option value="á¢áŸ’á“á€áŸáŸ†á¢á¶á">ğŸ§¹ á¢áŸ’á“á€áŸáŸ†á¢á¶á (Housekeeping)</option>
        <option value="á˜áŸ‰á¼áá¼áŒá»á”">ğŸï¸ á˜áŸ‰á¼áá¼áŒá»á” (Driver)</option>
        <option value="á¢áŸ’á“á€á›á€áŸ‹">ğŸ›ï¸ á¢áŸ’á“á€á›á€áŸ‹ (Sales)</option>
        <option value="á‘á‘á½á›á™á€á‚áŸ’ášá”áŸ‹á˜á»á">âœ… á‘á‘á½á›á™á€á‚áŸ’ášá”áŸ‹á˜á»á</option>
      </select>
    </div>
    <button class="next-btn" onclick="goToVoice()">á”á“áŸ’á‘á¶á”áŸ‹ â†’ áááŸáŸ†á¡áŸá„ ğŸ™</button>
  </div>
</div>

<div class="screen" id="screen-voice">
  <div class="header">
    <div class="header-top">
      <button class="back-btn" onclick="goBack('screen-profile')">â† ááŸ’ášá¡á”áŸ‹</button>
    </div>
  </div>
  <div class="voice-container">
    <div class="voice-job-card">
      <div class="voice-job-icon" id="vj-emoji">ğŸ½ï¸</div>
      <div class="voice-job-info">
        <div class="voice-job-title" id="vj-title">â€”</div>
        <div class="voice-job-company" id="vj-company">â€”</div>
      </div>
    </div>
    <div class="prompt-box">
      <div class="prompt-title">ğŸ¯ á“á·á™á¶á™áá¶...</div>
      <div class="prompt-text">á…á¼ášášáŸ€á”ášá¶á”áŸ‹ááŸ’á›á½á“á¢áŸ’á“á€á€áŸ’á“á»á„ áŸ¦áŸ  áœá·á“á¶á‘á¸</div>
      <div class="prompt-hints">
        <div class="prompt-hint">áˆáŸ’á˜áŸ„áŸ‡ á“á·á„á¢á¶á™á»ášá”áŸáŸ‹á¢áŸ’á“á€</div>
        <div class="prompt-hint">á˜á»áá„á¶ášáŠáŸ‚á›á¢áŸ’á“á€á…á„áŸ‹á”á¶á“</div>
        <div class="prompt-hint">á áŸáá»á¢áŸ’áœá¸á¢áŸ’á“á€á›áŸ’á¢áŸá˜áŸ’ášá¶á”áŸ‹á˜á»áá„á¶ášá“áŸáŸ‡</div>
      </div>
    </div>
    <div class="record-area">
      <div class="timer-ring">
        <svg viewBox="0 0 160 160">
          <circle class="timer-track" cx="80" cy="80" r="65"/>
          <circle class="timer-progress" id="timer-circle" cx="80" cy="80" r="65"/>
        </svg>
        <div class="timer-center">
          <div class="timer-seconds" id="timer-display">60</div>
          <div class="timer-label">áœá·á“á¶á‘á¸</div>
        </div>
        <button class="record-btn" id="record-btn" onclick="toggleRecording()">ğŸ™</button>
      </div>
      <div class="waveform" id="waveform">
        <div class="wave-bar" style="animation-delay:0s"></div>
        <div class="wave-bar" style="animation-delay:.1s"></div>
        <div class="wave-bar" style="animation-delay:.2s"></div>
        <div class="wave-bar" style="animation-delay:.3s"></div>
        <div class="wave-bar" style="animation-delay:.15s"></div>
        <div class="wave-bar" style="animation-delay:.05s"></div>
        <div class="wave-bar" style="animation-delay:.25s"></div>
        <div class="wave-bar" style="animation-delay:.1s"></div>
        <div class="wave-bar" style="animation-delay:.35s"></div>
        <div class="wave-bar" style="animation-delay:.2s"></div>
        <div class="wave-bar" style="animation-delay:0s"></div>
        <div class="wave-bar" style="animation-delay:.15s"></div>
      </div>
      <div class="record-status" id="record-status">á…á»á… ğŸ™ áŠá¾á˜áŸ’á”á¸á…á¶á”áŸ‹á•áŸ’áá¾á˜áá</div>
    </div>
    <div class="playback-section" id="playback-section">
      <button class="play-btn" onclick="playRecording()">â–¶</button>
      <div class="playback-info">
        <div class="playback-title">âœ… ááášá½á…á á¾á™!</div>
        <div class="playback-sub">á…á»á…áŸáŸ’áá¶á”áŸ‹ á¬ááá˜áŸ’áá„á‘áŸ€á</div>
      </div>
      <button class="rerecord-btn" onclick="resetRecording()">ááá˜áŸ’áá„á‘áŸ€á</button>
    </div>
    <button class="submit-btn" id="submit-btn" onclick="submitApplication()">ğŸ“¤ á”á‰áŸ’á‡á¼á“á–á¶á€áŸ’á™</button>
  </div>
</div>

<div class="screen" id="screen-success">
  <div class="success-container">
    <div class="success-anim">âœ…</div>
    <div>
      <div class="success-title">á”á¶á“á”á‰áŸ’á‡á¼á“<br><span>ášá½á…ášá¶á›áŸ‹á á¾á™!</span></div>
    </div>
    <div class="success-sub">
      á¢áŸ’á“á€á‡áŸ’ášá¾áŸášá¾áŸá”á»á‚áŸ’á‚á›á·á€á“á¹á„á‘á¶á€áŸ‹á‘á„á¢áŸ’á“á€<br>áá¶á˜ Telegram á¬á‘á¼ášáŸáŸá–áŸ’á‘á€áŸ’á“á»á„á–áŸá›á†á¶á”áŸ‹áŸ— ğŸ™
    </div>
    <div class="success-details">
      <div class="success-row">
        <div class="success-row-icon">ğŸ’¼</div>
        <div class="success-row-text"><strong id="success-job">â€”</strong>á˜á»áá„á¶ášáŠáŸ‚á›á”á¶á“áŠá¶á€áŸ‹á–á¶á€áŸ’á™</div>
      </div>
      <div class="success-row">
        <div class="success-row-icon">ğŸ‘¤</div>
        <div class="success-row-text"><strong id="success-name">â€”</strong>áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€</div>
      </div>
      <div class="success-row">
        <div class="success-row-icon">ğŸ“±</div>
        <div class="success-row-text"><strong id="success-phone">â€”</strong>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘</div>
      </div>
      <div class="success-row">
        <div class="success-row-icon">ğŸ™</div>
        <div class="success-row-text"><strong>á”á‰áŸ’á‡á¼á“áŸáŸ†á¡áŸá„ášá½á… âœ…</strong>á¢áŸ’á“á€á‡áŸ’ášá¾áŸášá¾áŸá“á¹á„áŸáŸ’áá¶á”áŸ‹á–á¶á€áŸ’á™á¢áŸ’á“á€</div>
      </div>
    </div>
    <button class="home-btn" onclick="goHome()">ğŸ” á˜á¾á›á€á¶ášá„á¶ášá•áŸ’áŸáŸá„á‘áŸ€á</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ CONFIG (NO SECRETS!) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL  = 'https://hqcfmqbzfrjjgdcclomx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxY2ZtcWJ6ZnJqamdkY2Nsb214Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMTMxMzUsImV4cCI6MjA4Njg4OTEzNX0.qosctxapm1JMhpL7xjG9CryrlJrZ7TSWrAsWDiQR1S0';
const TOTAL_SECS = 60;
const CIRCUMFERENCE = 408;

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON);

let selectedJob=null,mediaRecorder=null,audioChunks=[],audioBlob=null,audioURL=null,audioPlayer=null;
let isRecording=false,timerInterval=null,secondsLeft=TOTAL_SECS,recordedSecs=0;

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0)}
function goBack(id){showScreen(id)}
function goHome(){resetRecording();showScreen('screen-jobs')}

async function loadJobs(){
  const container=document.getElementById('jobs-list');
  try{
    const {data:jobs,error}=await db.from('jobs').select('*').eq('status','active').order('created_at',{ascending:false});
    if(error)throw error;
    if(!jobs||jobs.length===0){
      container.innerHTML=`<div class="error-wrap"><div class="error-icon">ğŸ“­</div><div class="error-title">á˜á·á“á˜á¶á“á€á¶ášá„á¶ášááŸ’á˜á¸</div><div class="error-sub">áŸá¼á˜á˜á¾á›á˜áŸ’áá„á‘áŸ€áá“áŸ…á–áŸá›á€áŸ’ášáŸ„á™</div></div>`;
      return;
    }
    container.innerHTML=`<div class="section-title">ğŸ’¼ á˜á»áá„á¶ášáŠáŸ‚á›á˜á¶á“ (${jobs.length})</div>`;
    jobs.forEach(job=>{
      const card=document.createElement('div');
      card.className='job-card';
      card.innerHTML=`
        <div class="job-header">
          <div class="job-emoji">${job.emoji||'ğŸ’¼'}</div>
          ${job.urgency?`<div class="job-urgency">âš¡ ${job.urgency}</div>`:''}
        </div>
        <div class="job-title">${job.title_km}</div>
        <div class="job-company">ğŸ¢ ${job.company_km} Â· ${job.location}</div>
        <div class="job-tags">
          <span class="tag">ğŸ• Full-time</span>
          <span class="tag">ğŸ“ ${job.location}</span>
          ${job.salary_range?`<span class="tag highlight">ğŸ’µ ${job.salary_range}</span>`:''}
        </div>
        <button class="apply-btn" onclick="selectJob('${job.id}')">ğŸ™ áŠá¶á€áŸ‹á–á¶á€áŸ’á™á¥á¡á¼áœ</button>`;
      container.appendChild(card);
    });
  }catch(err){
    console.error('Load jobs error:',err);
    container.innerHTML=`<div class="error-wrap"><div class="error-icon">âš ï¸</div><div class="error-title">á˜á¶á“á”á‰áŸ’á á¶</div><div class="error-sub">${err.message||'áŸá¼á˜á–á·á“á·ááŸ’á™á¢áŸŠá¸á“á’áºáá·á'}</div><button class="retry-btn" onclick="loadJobs()">á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€á</button></div>`;
  }
}

async function selectJob(jobId){
  const {data:job}=await db.from('jobs').select('*').eq('id',jobId).single();
  if(!job){showToast('âš ï¸ ášá€á˜á·á“áƒá¾á‰á€á¶ášá„á¶áš','error');return;}
  selectedJob=job;loadProfile();showScreen('screen-profile');
}

function loadProfile(){
  const p=JSON.parse(localStorage.getItem('va_profile')||'{}');
  if(p.name)document.getElementById('input-name').value=p.name;
  if(p.phone)document.getElementById('input-phone').value=p.phone;
  if(p.pos)document.getElementById('input-position').value=p.pos;
}
function saveProfile(name,phone,pos){localStorage.setItem('va_profile',JSON.stringify({name,phone,pos}))}

function goToVoice(){
  const name=document.getElementById('input-name').value.trim();
  const phone=document.getElementById('input-phone').value.trim();
  const pos=document.getElementById('input-position').value;
  if(!name||!phone||!pos){showToast('âš ï¸ áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á‘á¶áŸ†á„á¢áŸáŸ‹','error');return;}
  saveProfile(name,phone,pos);
  document.getElementById('vj-emoji').textContent=selectedJob.emoji||'ğŸ’¼';
  document.getElementById('vj-title').textContent=selectedJob.title_km;
  document.getElementById('vj-company').textContent=selectedJob.company_km;
  showScreen('screen-voice');
}

async function toggleRecording(){
  if(isRecording){stopRecording();return;}
  if(!window.isSecureContext){showToast('âš ï¸ ááŸ’ášá¼áœá€á¶áš HTTPS','error');return;}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    startRecording(stream);
  }catch(e){
    showToast('ğŸ¤ áŸá¼á˜ Allow á˜á¸á€áŸ’ášá¼á áŸ’áœá¼á“','error');
  }
}

function startRecording(stream){
  audioChunks=[];audioBlob=null;isRecording=true;secondsLeft=TOTAL_SECS;recordedSecs=0;
  mediaRecorder=new MediaRecorder(stream);
  mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
  mediaRecorder.onstop=finishRecording;
  mediaRecorder.start(100);
  const btn=document.getElementById('record-btn');
  btn.textContent='â¹';btn.classList.add('recording');
  document.getElementById('waveform').classList.add('active');
  document.getElementById('record-status').textContent='â— á€áŸ†á–á»á„áá...';
  document.getElementById('record-status').className='record-status recording';
  document.getElementById('playback-section').classList.remove('visible');
  document.getElementById('submit-btn').classList.remove('visible');
  updateTimer();
  timerInterval=setInterval(()=>{
    secondsLeft--;recordedSecs++;updateTimer();
    if(secondsLeft<=0)stopRecording();
  },1000);
}

function stopRecording(){
  if(!mediaRecorder)return;
  clearInterval(timerInterval);isRecording=false;
  mediaRecorder.stop();
  mediaRecorder.stream.getTracks().forEach(t=>t.stop());
  const btn=document.getElementById('record-btn');
  btn.textContent='ğŸ™';btn.classList.remove('recording');
  document.getElementById('waveform').classList.remove('active');
}

function finishRecording(){
  audioBlob=new Blob(audioChunks,{type:'audio/webm'});
  audioURL=URL.createObjectURL(audioBlob);
  audioPlayer=new Audio(audioURL);
  document.getElementById('record-status').textContent='âœ… ááášá½á…á á¾á™!';
  document.getElementById('record-status').className='record-status done';
  document.getElementById('playback-section').classList.add('visible');
  document.getElementById('submit-btn').classList.add('visible');
}

function playRecording(){if(audioPlayer){audioPlayer.currentTime=0;audioPlayer.play()}}

function resetRecording(){
  stopRecording();
  audioBlob=audioURL=audioPlayer=null;audioChunks=[];secondsLeft=TOTAL_SECS;recordedSecs=0;
  updateTimer();
  document.getElementById('record-btn').textContent='ğŸ™';
  document.getElementById('record-status').textContent='á…á»á… ğŸ™ áŠá¾á˜áŸ’á”á¸á…á¶á”áŸ‹á•áŸ’áá¾á˜áá';
  document.getElementById('record-status').className='record-status';
  document.getElementById('waveform').classList.remove('active');
  document.getElementById('playback-section').classList.remove('visible');
  document.getElementById('submit-btn').classList.remove('visible');
}

function updateTimer(){
  document.getElementById('timer-display').textContent=secondsLeft;
  const offset=CIRCUMFERENCE*(1-secondsLeft/TOTAL_SECS);
  const circle=document.getElementById('timer-circle');
  circle.style.strokeDashoffset=offset;
  const color=secondsLeft>20?'var(--red)':secondsLeft>10?'var(--gold)':'#ff4444';
  circle.style.stroke=color;
  document.getElementById('timer-display').style.color=secondsLeft<=10?'#ff4444':'var(--text)';
}

async function submitApplication(){
  if(!audioBlob){showToast('âš ï¸ áŸá¼á˜áááŸáŸ†á¡áŸá„á‡á¶á˜á»á“','error');return;}
  const btn=document.getElementById('submit-btn');
  btn.classList.add('loading');btn.textContent='â³ á€áŸ†á–á»á„á”á‰áŸ’á‡á¼á“...';
  const name=document.getElementById('input-name').value.trim();
  const phone=document.getElementById('input-phone').value.trim();
  const pos=document.getElementById('input-position').value;
  try{
    const timestamp=Date.now();
    const filePath=`voices/${selectedJob.id}/${phone}_${timestamp}.webm`;
    const {data:uploadData,error:uploadError}=await db.storage.from('voices').upload(filePath,audioBlob,{contentType:'audio/webm',cacheControl:'3600',upsert:false});
    if(uploadError)throw new Error('Upload failed: '+uploadError.message);
    const {data:urlData}=db.storage.from('voices').getPublicUrl(filePath);
    const voiceUrl=urlData.publicUrl;
    const {data:appData,error:appError}=await db.from('applications').insert({
      job_id:selectedJob.id,applicant_name:name,applicant_phone:phone,
      position_wanted:pos,voice_url:voiceUrl,voice_duration:recordedSecs,status:'new'
    }).select().single();
    if(appError)throw new Error('Save failed: '+appError.message);
    await db.from('workers').upsert({name,phone,position_wanted:pos},{onConflict:'phone'});
    
    // âœ… TELEGRAM NOTIFICATION NOW HANDLED BY EDGE FUNCTION AUTOMATICALLY!
    // The database trigger will call the Edge Function which sends Telegram messages
    
    document.getElementById('success-job').textContent=selectedJob.title_km;
    document.getElementById('success-name').textContent=name;
    document.getElementById('success-phone').textContent=phone;
    showScreen('screen-success');
  }catch(err){
    console.error('Submit error:',err);
    showToast('âŒ '+(err.message||'á˜á¶á“á”á‰áŸ’á á¶'),'error');
    btn.classList.remove('loading');btn.innerHTML='ğŸ“¤ á”á‰áŸ’á‡á¼á“á–á¶á€áŸ’á™';
  }
}

function showToast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'),3500);
}

loadProfile();updateTimer();loadJobs();
</script>
</body>
</html>
